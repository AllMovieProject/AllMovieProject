<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sist.web.mapper.MypageMapper">
  <resultMap id="bookingInfoMap" type="BookingVO">
    <id property="booking_id" column="booking_id" />
    <result property="schedule_id" column="schedule_id" />
    
    <association property="svo" javaType="ScheduleVO">
      <result property="sday" column="sday" />
      <result property="start_time" column="start_time" />
      <result property="end_time" column="end_time" />
    </association>

    <association property="mvo" javaType="MovieVO">
      <result property="title" column="title" />
      <result property="movie_type" column="movie_type" />
      <result property="rating" column="rating" />
      <result property="poster_url" column="poster_url" />
    </association>

    <association property="tvo" javaType="TheaterVO">
      <result property="theater_name" column="theater_name" />
    </association>

    <association property="scvo" javaType="ScreenVO">
      <result property="screen_name" column="screen_name" />
    </association>

    <collection property="sevo" ofType="SeatVO">
      <result property="seat_row" column="seat_row" />
      <result property="seat_col" column="seat_col" />
    </collection>
  </resultMap>

  <select id="bookingListData" resultMap="bookingInfoMap"
    parameterType="string">
    SELECT b.booking_id, b.schedule_id,  m.title, m.movie_type, m.rating, m.poster_url,
    t.theater_name, sc.screen_name, TO_CHAR(s.start_time, 'YYYY.MM.DD') AS sday, TO_CHAR(s.start_time, 'HH24:MI') AS starttime,
    TO_CHAR(s.end_time, 'HH24:MI') AS endtime, se.seat_row,  se.seat_col
    FROM booking b
    
    JOIN schedule s ON s.schedule_id = b.schedule_id
    JOIN movie m ON m.movie_id = s.movie_id
    JOIN screen sc ON sc.screen_id = s.screen_id
    JOIN theater t ON sc.theater_id = t.theater_id
    LEFT JOIN booking_seat bs ON b.booking_id = bs.booking_id
    LEFT JOIN seat se ON se.seat_id = bs.seat_id
    
    WHERE b.member_id = #{id}
  </select>
  </mapper>