<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sist.web.mapper.BookingMapper">
  <select id="dynamicDateListData" resultType="ScheduleVO"
    parameterType="hashmap">
		SELECT DISTINCT TO_CHAR(s.schedule_date, 'yyyy-mm-dd') as sday
    FROM schedule s
    
    JOIN screen sc
    	ON s.screen_id = sc.screen_id
    JOIN theater t
    	ON t.theater_id = sc.theater_id
    JOIN movie m
    	ON m.movie_id = s.movie_id
    
    WHERE s.schedule_date >= SYSDATE
    <if test="movie != null and movie != 0">
    	AND m.movie_id = #{movie}
    </if>
    <if test="theater != null and theater != ''">
    	AND t.theater_id = #{theater}
    </if>
    
    ORDER BY sday ASC
  </select>
  
  <select id="dynamicMovieListData" resultType="MovieVO"
    parameterType="hashmap">
		SELECT DISTINCT m.movie_id, m.title, m.rating
    FROM movie m
    
    JOIN schedule s
      ON s.movie_id = m.movie_id
    JOIN screen sc
      ON sc.screen_id = s.screen_id
    JOIN theater t
      ON t.theater_id = sc.theater_id
    
    WHERE s.schedule_date >= SYSDATE
    <if test="region != null and region != 0">
      AND t.region_no = #{region}
    </if>
    <if test="theater != null and theater != ''">
      AND t.theater_id = #{theater}
    </if>
    
    ORDER BY m.title ASC
  </select>

  <select id="dynamicTheaterListData" resultType="TheaterVO"
    parameterType="hashmap">
    SELECT DISTINCT t.theater_name, t.theater_id, t.region_no
		FROM theater t
		
		JOIN screen sc
  		ON sc.theater_id = t.theater_id
		JOIN schedule s
  		ON s.screen_id = sc.screen_id
		JOIN movie m
  		ON m.movie_id = s.movie_id
  	
  	WHERE s.schedule_date >= SYSDATE
  	<if test="movie != null and movie != 0">
  	  AND m.movie_id = #{movie}
  	</if>
    
    ORDER BY t.theater_name ASC
  </select>
  
  <resultMap type="MovieVO" id="movieMap">
  	<result property="mvo.title" column="title" />
  	<result property="mvo.movie_type" column="movie_type" />
  	<result property="mvo.runtime" column="runtime" />
  </resultMap>
  
  <resultMap type="TheaterVO" id="theaterMap">
  	<result property="tvo.theater_name" column="theater_name" />
  </resultMap>
  
  <resultMap type="ScreenVO" id="screenMap">
  	<result property="svo.screen_name" column="screen_name"/>
  </resultMap>
  
  <resultMap type="ScheduleSeatVO" id="seatVO">
  	<result property="ssvo.reservation_flag" column="reservation_flag" />
  </resultMap>
  
  <select id="dynamicScheduleListData"></select>
</mapper>